ads_version: "1.0"
type: specification
agent: all
tier: 2
priority: high
validates_with: AgentQMS/standards/schemas/compliance-checker.py
compliance_status: pass
last_updated: '2026-01-20'

component: model_management
description: Manages the lifecycle of models (detection, recognition, etc.) for loading, inference, and unloading.
role: |
  Abstracts away the PyTorch Lightning / Hydra complexity. Provides a simple 'predict(tensor)' interface to the orchestrator.
critical_logic:
  - id: checkpoint-loading
    description: |
      Loads weights from `.ckpt` file.
      Optimization: Caches the model in memory (Singleton pattern) to avoid reloading per request.
      Reason: Serverless-like behavior (cold start vs warm start).
  - id: configuration-inference
    description: |
      Models require 4 components: 'Encoder', 'Decoder', 'Head', 'Transforms'.
      These are defined in Hydra V5.0 domain configs (domain/detection.yaml, domain/recognition.yaml, etc.).
      Auto-Discovery: If 'checkpoint.pth' is at '/foo/bar/checkpoints/epoch=1.ckpt', manager looks for '.hydra/config.yaml' or 'config.yaml' in parent directories.
      See: AgentQMS/standards/tier2-framework/hydra-v5-rules.yaml
  - id: resource-management
    description: |
      Cleanup: Calls 'torch.cuda.empty_cache()' on model swap to prevent OutOfMemory (OOM) errors on 8GB GPUs.
      Device: Defaults to 'cuda' if available, else 'cpu'.
  - id: initialization-stability
    description: |
      [BUG-001] DBHead biases must be initialized to background prior (p=0.01) to prevent "Red Line" saturation failure during scratch training.
      Uninitialized biases (~0.0) result in ~0.5 probability, causing all-positive masks.
data_contract:
  input:
    - field: checkpoint_path
      description: API/Config provided path
  output:
    - field: LightingModule
      description: Loaded model on device
