ads_version: "1.0"
type: specification
agent: all
tier: 2
priority: high
validates_with: AgentQMS/standards/schemas/compliance-checker.py
compliance_status: pass
last_updated: '2026-01-20'

component: preprocessing_logic
description: Prepares raw images for inference.
role: |
  Applies resolution standardization, padding, normalization, and optional geometric corrections.
critical_logic:
  - id: pipeline-stages
    description: |
      1. Decode: Convert Base64/Bytes to BGR Numpy Array (Opencv format).
      2. Perspective Correction (Optional):
         - If 'enable_perspective_correction=True'.
         - Uses 'rembg' or corner detection logic to find document corners.
         - Warps image to 'flat' view.
         - Note: This changes the 'original_size' effective for downstream coordinate mapping.
      3. Resize & Pad:
         - Resizes to 'target_size' (default 640) preserving aspect ratio.
         - Pads right/bottom to reach exact 640x640 square.
      4. Normalize:
         - Standard ImageNet mean/std (if generic model) or custom stats.
         - Converts to Float32 Tensor (1, C, H, W).
  - id: configuration
    description: |
      Configuration is loaded from Hydra V5.0 domain configs (domain/detection.yaml, etc.) or can be overridden per request.
      - target_size: int (default 640)
      - transform_pipeline: List[str] (names of albumentations transforms)
      See: AgentQMS/standards/tier2-framework/hydra-v5-rules.yaml
  - id: display-modes
    description: |
      Corrected: The preview image shows the 'After Warp' view.
      Original: The preview image shows the raw input, requiring inverse-inverse mapping (complex). Currently defaults to Corrected view for simplicity.
data_contract:
  input:
    - field: image
      type: np.ndarray
    - field: settings
      type: PreprocessSettings
  output:
    - field: result
      type: PreprocessingResult
      description: Tensor + Metadata + OriginalImage
