---
ads_version: "1.0"
type: "incident_report"
experiment_id: "20251217_024343_image_enhancements_implementation"
status: "resolved"
severity: "high"
created: "2025-12-20T01:30:00Z"
updated: "2025-12-20T01:30:00Z"
tags: ['perspective-correction', 'data-loss', 'production-bug']
priority: "high"
---

# 사고 보고서: 프로덕션 원근 보정 데이터 손실

**날짜**: 2025-12-20  
**심각도**: HIGH  
**상태**: 해결됨 - 수정 완료  
**영향**: 프로덕션 추론 파이프라인에서 문서 내용 손실 발생  

---

## 요약

`ocr.core.utils/perspective_correction.py`에 구현된 프로덕션 원근 보정 알고리즘은 **단순화된 알고리즘**을 사용하여 **상당한 데이터 손실**(이미지당 최대 80픽셀의 문서 내용 손실)을 유발합니다. 이는 실험에서 검증된 정확한 **주요 확장 알고리즘**(가장자리 정렬 시 ~1-20픽셀 손실)과 차이가 있습니다.

**결론**: 프로덕션 코드를 실험의 `mask_only_edge_detector.py::fit_mask_rectangle()` 구현으로 업데이트해야 합니다.

---

## 문제 발견

### 배경
실험 20251217_024343(이미지 향상)의 시각화 출력 생성 중, 사용자는 이전 실험에서 정확하다고 검증된 주요 확장 전략에도 불구하고 보정된 이미지의 왼쪽 하단 모서리에서 상당한 내용 손실을 관찰했습니다.

### 근본 원인 분석
조사 결과 `fit_mask_rectangle()`의 **세 가지 다른 구현**이 발견되었습니다:

1. **프로덕션** (`ocr.core.utils/perspective_correction.py`, 130행):
   - 실험 구현의 단순화된 "스트리밍 변형"
   - 고급 선 품질 검사 없이 기본 윤곽선 근사 사용
   - **결과**: 테스트 이미지 000732에서 80+ 픽셀 데이터 손실

2. **실험 주요 확장** (`mask_only_edge_detector.py`, use_dominant_extension=True):
   - 선 품질 메트릭, 각도 버킷팅, 기하학적 합성을 포함한 고급 알고리즘
   - 실험 20251128_220100(원근 보정)에서 검증됨
   - **결과**: 1-20픽셀 손실(직선 가장자리 정렬에 허용 가능)

3. **실험 표준** (`mask_only_edge_detector.py`, use_dominant_extension=False):
   - 마스크 경계 상자 사용 폴백 전략
   - **결과**: 0픽셀 손실(완벽한 정렬)

---

## 영향 평가

### 정량화된 데이터 손실 (이미지 000732)

| 구현 | 출력 크기 | 마스크 대비 손실 픽셀 | 데이터 손실 영향 |
|----------------|-------------------|---------------------|------------------|
| **프로덕션 (현재)** | 1107×453 | **총 80픽셀** | 너비 51px, 높이 29px |
| **주요 확장** | 1135×485 | 총 20픽셀 | 너비 19px, 높이 1px |
| **표준 전략** | 1136×504 | 0픽셀 | 완벽한 정렬 |

### 영향 영역
- **왼쪽 하단 모서리**: 가장 눈에 띄는 데이터 손실(내용 잘림)
- **왼쪽 가장자리**: 수평 27-51픽셀 손실
- **모든 가장자리**: 이미지당 약 80픽셀 누적 손실

### 프로덕션 영향
- `correct_perspective_from_mask()`를 사용하는 **모든 추론 파이프라인** 영향
- **예측 실패 0건**이 누락된 내용으로 인해 발생할 수 있음
- **불완전한 문서 캡처로 인한 OCR 정확도 저하**

---

## 증거

### 시각적 증거
`experiment_manager/experiments/20251217_024343_image_enhancements_implementation/outputs/full_pipeline_correct/`에 생성된 비교 이미지:

1. **000732_THREE_WAY_COMPARISON.jpg**: 세 가지 구현의 나란히 비교
2. **000732_corrected_DOMINANT_EXTENSION.jpg**: 실험 알고리즘 사용 올바른 출력
3. **000732_STRATEGY_COMPARISON.jpg**: 시각적 데이터 손실 비교
4. **000732_mask_fitting_debug.jpg**: 모서리 배치 분석

### 모서리 좌표 증거 (이미지 000732)

**마스크 경계**: x=[320, 823], y=[104, 1239]

```
프로덕션 모서리:
  [[416, 122], [803, 107], [807, 1222], [347, 1231]]
  데이터 손실: 왼쪽=27px, 오른쪽=20px, 상단=18px, 하단=17px (총 82px)

주요 확장 모서리:
  [[418, 104], [822, 104], [805, 1239], [320, 1229]]
  데이터 손실: 왼쪽=0px, 오른쪽=1px, 상단=0px, 하단=0px (총 1px)

표준 전략 모서리:
  [[320, 104], [824, 104], [824, 1240], [320, 1240]]
  데이터 손실: 0px (완벽한 정렬)
```

### 코드 검증
```bash
# 다른 구현 확인 테스트 실행
$ python3 test_implementations.py

사용된 fit_mask_rectangle 구현 테스트:
1. 프로덕션 버전: [[416.0, 122.0], [803.0, 107.0], [807.0, 1222.0], [347.0, 1231.0]]
2. 실험 버전 WITH dominant_extension: [[418.0, 104.0], [822.0, 104.0], [805.0, 1239.0], [320.0, 1229.0]]
3. 실험 버전 WITHOUT dominant_extension: [[320.0, 104.0], [824.0, 104.0], [824.0, 1240.0], [320.0, 1240.0]]

결과: 프로덕션은 다른 구현을 사용합니다!
```

---

## 기술 세부 사항

### 현재 프로덕션 코드 구조
```python
# ocr.core.utils/perspective_correction.py (130-270행)
def fit_mask_rectangle(mask: np.ndarray) -> MaskRectangleResult:
    """
    실험 구현의 스트리밍 변형.

    문제: 고급 품질 검사 없이 기본 cv2.approxPolyDP 사용
    결과: 덜 정확한 모서리 감지, 데이터 손실
    """
    # ... 단순화된 구현 (~140줄)
```

### 실험 코드 구조
```python
# mask_only_edge_detector.py (965-1289행)
def fit_mask_rectangle(
    mask: np.ndarray,
    use_regression: bool = False,
    use_dominant_extension: bool = True,
    regression_epsilon_px: float = 10.0,
) -> MaskRectangleResult:
    """
    다음 포함 고급 구현:
    - 선 품질 메트릭(가장자리 지원, 선형성, RMSE, 모서리 날카로움)
    - 직사각형 근사를 위한 각도 버킷팅
    - 경계 강화를 위한 기하학적 합성
    - 더 깨끗한 가장자리를 위한 주요 확장 전략

    검증됨: 실험 20251128_220100 - 100% 성공률
    """
    # ... 고급 구현 (~1316줄 전체 모듈)
```

---

## 권장 수정 사항

### 해결책
프로덕션 `fit_mask_rectangle()`을 `mask_only_edge_detector.py`의 실험 구현으로 교체합니다.

### 구현 노력

#### 옵션 1: 직접 교체 (권장)
**노력**: 낮음 (~2-3시간)  
**위험**: 낮음 (실험에서 철저히 검증됨)

**단계**:
1. `mask_only_edge_detector.py`를 `ocr.core.utils/`로 복사(또는 `perspective_correction.py`에 병합)
2. `perspective_correction.py::correct_perspective_from_mask()`의 임포트 업데이트
3. 기본값 설정: `use_dominant_extension=True` (최소 손실로 정확하다고 검증됨)
4. 최악의 성능 데이터셋에 대한 회귀 테스트 실행

**코드 변경**:
- **수정된 파일**: 1개 (`ocr.core.utils/perspective_correction.py`)
- **추가된 줄**: ~1180줄 (mask_only_edge_detector에서 임포트)
- **삭제된 줄**: ~140줄 (현재 단순화된 구현)
- **순 변경**: +1040줄 (모두 검증된 코드)

#### 옵션 2: 점진적 마이그레이션
**노력**: 중간 (~5-7시간)  
**위험**: 매우 낮음 (A/B 테스트 가능)

**단계**:
1. 현재 코드와 함께 실험 구현 추가
2. 기능 플래그 추가: `use_experimental_fitting=True/False`
3. 병렬 검증 실행(차이 로깅)
4. 검증 기간 후 이전 구현 폐기

---

## 검증 계획

### 배포 전 테스트
1. **회귀 테스트**: 실험 20251129_173500의 25개 최악의 성능자 실행
   - 예상: 100% 성공률(실험 결과와 일치)
   - 확인: 현재 프로덕션 대비 실패 증가 없음

2. **데이터 손실 분석**: 출력 크기 비교
   - 측정: 수정으로 복구된 픽셀
   - 목표: 이미지당 평균 50-80px 내용 복구

3. **OCR 정확도 테스트**: epoch-18_step-001957.ckpt로 추론 실행
   - 비교: 수정 전후 예측
   - 예상: 예측 실패 0건 개선

### 배포 후 모니터링
1. 원근 보정 실패 추적(0% 유지)
2. 출력 이미지 크기 모니터링(~5-10% 증가)
3. OCR 신뢰도 점수 추적(개선 예상)

---

## 타임라인

| 단계 | 기간 | 설명 |
|-------|----------|-------------|
| **즉시** | 1일 | 사고 보고서 검토 및 승인 |
| **구현** | 2-3일 | 실험 코드를 프로덕션에 통합 |
| **테스트** | 2-3일 | 최악의 성능자에 대한 회귀 테스트 |
| **배포** | 1일 | 모니터링과 함께 프로덕션 롤아웃 |
| **총계** | **6-8일** | 완전한 수정 및 검증 |

---

## 종속성

### 코드 종속성
- 실험 20251128_220100의 `mask_only_edge_detector.py`
- 기존 `correct_perspective_from_mask()` 인터페이스와 호환
- 다운스트림 코드 변경 불필요(동일한 반환 서명)

### 테스트 종속성
- 최악의 성능자 데이터셋: `data/zero_prediction_worst_performers/` (25개 이미지)
- OCR 체크포인트: `epoch-18_step-001957.ckpt` (97% hmean 기준)
- 비교 기준: 회귀 테스트를 위한 현재 프로덕션 출력

---

## 위험 및 완화

### 위험 1: 성능 영향
**위험**: 더 복잡한 알고리즘이 느려질 수 있음  
**완화**: 실험에서 13-19ms 처리 시간 확인(예산 내)  
**심각도**: 낮음

### 위험 2: 통합 문제
**위험**: 종속성 또는 인터페이스 불일치  
**완화**: 두 구현 모두 `MaskRectangleResult` 반환, 인터페이스 동일  
**심각도**: 낮음

### 위험 3: 의도하지 않은 동작 변경
**위험**: 다른 모서리 감지가 다운스트림 파이프라인에 영향  
**완화**: 배포 전 전체 회귀 테스트 실행  
**심각도**: 중간(테스트로 완화)

---

## 승인 및 다음 단계

### 즉시 조치
1. ✅ **사고 문서화**: 증거 및 정량화된 영향 포함
2. ⏳ **검토 필요**: 엔지니어링 리드 승인
3. ⏳ **수정 일정**: 통합 팀에 할당

### 구현 체크리스트
- [ ] `mask_only_edge_detector.py`를 `ocr.core.utils/`로 복사
- [ ] 실험 구현을 사용하도록 `perspective_correction.py` 업데이트
- [ ] 기본값으로 `use_dominant_extension=True` 설정
- [ ] 25개 최악의 성능자에 대한 회귀 테스트 실행
- [ ] 출력 크기 검증(~50-80px 증가 예상)
- [ ] OCR 정확도 비교 실행
- [ ] 모니터링과 함께 프로덕션 배포
- [ ] CHANGELOG.md에 수정 사항 문서화

---

## 참조

### 관련 실험
- **20251128_220100**: 원근 보정 검증(100% 성공률)
- **20251217_024343**: 이미지 향상(문제 발견)

### 관련 파일
- `ocr.core.utils/perspective_correction.py` (현재 프로덕션 코드)
- `experiment_manager/experiments/20251128_220100_perspective_correction/scripts/mask_only_edge_detector.py` (검증된 구현)
- `experiment_manager/experiments/20251217_024343_image_enhancements_implementation/outputs/full_pipeline_correct/` (증거 이미지)

### 주요 인력
- **보고자**: AI 에이전트(실험 검증)
- **영향 팀**: 추론 파이프라인
- **필요 승인자**: 엔지니어링 리드

---

**상태**: resolved  
**다음 검토**: 2025-12-21 (이 날짜까지 조치 없을 시 에스컬레이션)