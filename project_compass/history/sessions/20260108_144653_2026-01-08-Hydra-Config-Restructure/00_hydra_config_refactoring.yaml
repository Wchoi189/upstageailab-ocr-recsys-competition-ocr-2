roadmap:
  title: "Hydra Configuration Architecture Restructuring"
  status: "in-progress"
  owner: "User & AI Agent"
  start_date: "2026-01-08"
  target_completion: "2026-01-10"

  objective: |
    Restructure Hydra configuration from 107 YAML files across 37 directories
    to ~50 files across 15 directories with domain-first organization.

  goals:
    - "Reduce configuration complexity and duplication"
    - "Improve discoverability with domain-first organization"
    - "Simplify entry point configuration (train, eval, predict)"
    - "Maintain backward compatibility during transition"
    - "Enable easier experimentation and configuration composition"

  metrics:
    baseline:
      yaml_files: 107
      directories: 37
      root_configs: 6
    target:
      yaml_files: "< 60"
      directories: "< 20"
      root_configs: "≤ 5"

  implementation_plan: "docs/artifacts/implementation_plans/2026-01-08_0359_implementation_plan_hydra-config-restructuring.md"
  session_tracking: "project_compass/active_context/current_session.yml"

  phases:
    - name: "Phase 0: Discovery & Analysis"
      status: "completed"
      completed_date: "2026-01-08"
      description: "Analyze current configuration dependencies and entry points"
      deliverables:
        - "✅ Hydra entry points mapped (14 entry points)"
        - "✅ Config access patterns analyzed (120 patterns)"
        - "✅ Component factories identified (814 patterns)"
        - "✅ Baseline snapshot created"
        - "✅ Config flow documentation"
      outputs:
        - "analysis/hydra_entry_points.json"
        - "analysis/configs_structure_before.txt"
        - "analysis/file_count_before.txt"
        - "analysis/component_factories.json"
        - "analysis/phase0_summary.md"
      tools_used:
        - "Agent Debug Toolkit (ADT) MCP tools"
        - "find_hydra_usage, analyze_config_access, find_component_instantiations"
      notes: |
        All discovery tasks completed successfully using MCP tools.
        Key findings: 14 entry points, 120 config access patterns, 814 factory patterns.
        Baseline validated: 107 YAML files / 37 directories.

    - name: "Phase 1: Foundation Setup"
      status: "pending"
      description: "Non-breaking foundation changes and directory structure"
      dependencies: ["Phase 0"]
      risk_level: "low"
      breaking_changes: false
      estimated_duration: "2 hours"
      deliverables:
        - "configs/_foundation/ (renamed from _base/)"
        - "configs/_foundation/defaults.yaml"
        - "configs/domain/ (new directory)"
        - "configs/training/ (new directory)"
        - "configs/__EXTENDED__/ (new directory)"
        - "Updated configs/README.md"
      tasks:
        - id: "P1-T1"
          description: "Create new directory structure"
          command: "mkdir -p configs/{_foundation,domain,training/{callbacks,logger,profiling},__EXTENDED__/{kie_variants,benchmarks,examples,experiments}}"
        - id: "P1-T2"
          description: "Rename _base/ to _foundation/"
          command: "mv configs/_base configs/_foundation"
        - id: "P1-T3"
          description: "Create _foundation/defaults.yaml"
          command: "cp configs/base.yaml configs/_foundation/defaults.yaml"
        - id: "P1-T4"
          description: "Update README.md with migration notices"
          files: ["configs/README.md"]
      validation:
        - "Directory structure exists"
        - "Old _base/ references still work (symlink created)"
        - "No broken imports in codebase"
      notes: "All changes are additive. Existing configs continue to work."

    - name: "Phase 2: Domain Unification"
      status: "pending"
      description: "Create unified domain configuration files"
      dependencies: ["Phase 1"]
      risk_level: "low"
      breaking_changes: false
      estimated_duration: "4 hours"
      deliverables:
        - "configs/domain/detection.yaml"
        - "configs/domain/recognition.yaml"
        - "configs/domain/kie.yaml"
        - "configs/domain/layout.yaml"
      tasks:
        - id: "P2-T1"
          description: "Merge detection configs into domain/detection.yaml"
          source_configs: ["configs/model/craft.yaml", "configs/model/db.yaml"]
        - id: "P2-T2"
          description: "Merge recognition configs into domain/recognition.yaml"
          source_configs: ["configs/recognition/*.yaml"]
        - id: "P2-T3"
          description: "Consolidate KIE configs into domain/kie.yaml"
          source_configs: ["configs/extraction/*.yaml"]
        - id: "P2-T4"
          description: "Create layout analysis config domain/layout.yaml"
          source_configs: ["configs/layout/*.yaml"]
      validation:
        - "Domain configs compose correctly"
        - "All model variants accessible via defaults list"
        - "No configuration key conflicts"
      notes: "Use Hydra defaults list pattern for variant selection."

    - name: "Phase 3: Entry Point Simplification"
      status: "pending"
      description: "Simplify root entry point configurations"
      dependencies: ["Phase 2"]
      risk_level: "medium"
      breaking_changes: true
      estimated_duration: "3 hours"
      deliverables:
        - "configs/train.yaml (updated with domain composition)"
        - "configs/eval.yaml (renamed from test.yaml)"
        - "configs/predict.yaml (updated)"
        - "configs/synthetic.yaml (updated)"
      tasks:
        - id: "P3-T1"
          description: "Update train.yaml to use domain composition"
          validation: "Hydra composition test passes"
        - id: "P3-T2"
          description: "Rename test.yaml to eval.yaml"
          migration_note: "Backward compatibility via symlink"
        - id: "P3-T3"
          description: "Archive KIE variant configs to __EXTENDED__/kie_variants/"
          files: ["configs/train_kie*.yaml"]
        - id: "P3-T4"
          description: "Update config_name references in runner scripts"
          affected_scripts:
            - "runners/train.py"
            - "runners/test.py"
            - "runners/predict.py"
      validation:
        - "All entry points compose without errors"
        - "Backward compatibility maintained via symlinks"
        - "Runner scripts reference correct config names"
      approval_required: true
      notes: |
        BREAKING CHANGES: Requires stakeholder approval.
        Create deprecation notices and migration guide.

    - name: "Phase 4: Infrastructure Reorganization"
      status: "pending"
      description: "Consolidate training infrastructure configs"
      dependencies: ["Phase 3"]
      risk_level: "low"
      breaking_changes: false
      estimated_duration: "3 hours"
      deliverables:
        - "configs/training/callbacks/"
        - "configs/training/logger/"
        - "configs/training/profiling/"
        - "configs/__EXTENDED__/examples/"
        - "configs/__EXTENDED__/benchmarks/"
      tasks:
        - id: "P4-T1"
          description: "Move callbacks configs to training/callbacks/"
          source: "configs/callbacks/"
        - id: "P4-T2"
          description: "Consolidate logger configs to training/logger/"
          source: ["configs/logger/", "configs/ui_meta/"]
        - id: "P4-T3"
          description: "Move profiling configs to training/profiling/"
          source: "configs/profiler/"
        - id: "P4-T4"
          description: "Archive examples to __EXTENDED__/examples/"
          source: "configs/examples/"
        - id: "P4-T5"
          description: "Archive benchmarks to __EXTENDED__/benchmarks/"
          source: "configs/benchmark/"
      validation:
        - "All callback compositions work"
        - "Logger configurations accessible"
        - "No broken references in training configs"

    - name: "Phase 5: Script Updates"
      status: "pending"
      description: "Update all Hydra entry point scripts"
      dependencies: ["Phase 4"]
      risk_level: "medium"
      breaking_changes: false
      estimated_duration: "4 hours"
      deliverables:
        - "Updated runner scripts (train.py, test.py, predict.py, etc.)"
        - "Updated benchmark scripts"
        - "Updated preprocessing scripts"
      tasks:
        - id: "P5-T1"
          description: "Update main runner scripts"
          files:
            - "runners/train.py"
            - "runners/test.py"
            - "runners/predict.py"
            - "runners/generate_synthetic.py"
            - "runners/train_kie.py"
          changes: "Update config_path, config_name, handle deprecated paths"
        - id: "P5-T2"
          description: "Update data preprocessing scripts"
          files:
            - "scripts/data/preprocess.py"
            - "scripts/data/preprocess_maps.py"
        - id: "P5-T3"
          description: "Update performance benchmark scripts"
          files:
            - "scripts/performance/benchmark_optimizations.py"
            - "scripts/performance/decoder_benchmark.py"
        - id: "P5-T4"
          description: "Update archived scripts with deprecation notices"
          files: ["archive/**/*hydra*.py"]
      validation:
        - "All scripts run without import errors"
        - "Config composition works for all entry points"
        - "Backward compatibility paths tested"
      tools_required:
        - "Agent Debug Toolkit for finding all @hydra.main decorators"

    - name: "Phase 6: Verification & Validation"
      status: "pending"
      description: "Comprehensive testing and validation"
      dependencies: ["Phase 5"]
      risk_level: "low"
      breaking_changes: false
      estimated_duration: "3 hours"
      deliverables:
        - "Hydra composition test suite"
        - "Smoke test results"
        - "Before/after metrics comparison"
        - "AgentQMS validation report"
      tasks:
        - id: "P6-T1"
          description: "Run Hydra composition tests"
          command: "pytest tests/configs/ -v"
        - id: "P6-T2"
          description: "Execute smoke tests for all entry points"
          tests:
            - "python runners/train.py --help"
            - "python runners/test.py --help"
            - "python runners/predict.py --help"
        - id: "P6-T3"
          description: "Validate with AgentQMS compliance"
          command: "cd AgentQMS/bin && make validate && make compliance"
        - id: "P6-T4"
          description: "Generate before/after metrics comparison"
          outputs:
            - "analysis/configs_structure_after.txt"
            - "analysis/file_count_after.txt"
            - "analysis/metrics_comparison.md"
      success_criteria:
        - "All composition tests pass"
        - "Zero import errors"
        - "File count < 60 YAML files"
        - "Directory count < 20"
        - "Root configs ≤ 5"
        - "AgentQMS validation passes"

    - name: "Phase 7: Documentation & Cleanup"
      status: "pending"
      description: "Update documentation and remove deprecated files"
      dependencies: ["Phase 6"]
      risk_level: "low"
      breaking_changes: false
      estimated_duration: "3 hours"
      deliverables:
        - "Updated configs/README.md"
        - "Migration guide (docs/guides/hydra_config_migration.md)"
        - "Updated architecture documentation"
        - "Cleanup of deprecated files"
      tasks:
        - id: "P7-T1"
          description: "Update main configuration README"
          file: "configs/README.md"
          content: "Document new structure, domain organization, migration path"
        - id: "P7-T2"
          description: "Create migration cheatsheet"
          file: "docs/guides/hydra_config_migration.md"
          content: "Old path → New path mappings, examples, troubleshooting"
        - id: "P7-T3"
          description: "Update architecture documentation"
          files:
            - "docs/architecture/configuration_system.md"
            - "docs/guides/configuration.md"
        - id: "P7-T4"
          description: "Remove deprecated base.yaml"
          command: "rm configs/base.yaml"
          note: "Only after migration period expires"
        - id: "P7-T5"
          description: "Clean up temporary symlinks"
          command: "find configs/ -type l -name '*deprecated*' -delete"
      validation:
        - "Documentation is clear and accurate"
        - "Migration guide tested by user"
        - "No broken links in documentation"

    - name: "Phase 8: CI/CD Integration"
      status: "pending"
      description: "Update CI/CD pipelines and Docker configurations"
      dependencies: ["Phase 7"]
      risk_level: "low"
      breaking_changes: false
      estimated_duration: "2 hours"
      deliverables:
        - "Updated GitHub Actions workflows"
        - "Updated Docker configurations"
        - "Updated test configurations"
      tasks:
        - id: "P8-T1"
          description: "Update GitHub Actions workflows"
          files:
            - ".github/workflows/test.yml"
            - ".github/workflows/train.yml"
          changes: "Update config paths, add validation steps"
        - id: "P8-T2"
          description: "Update Docker configurations"
          files:
            - "docker/Dockerfile"
            - "docker/docker-compose.yml"
          changes: "Update COPY commands for new config structure"
        - id: "P8-T3"
          description: "Update pytest configuration"
          file: "pytest.ini"
          changes: "Add config validation test markers"
        - id: "P8-T4"
          description: "Run full CI/CD pipeline test"
          validation: "All CI/CD jobs pass with new structure"
      validation:
        - "GitHub Actions pass"
        - "Docker builds successfully"
        - "All automated tests pass"

  risks:
    - risk: "Breaking existing user workflows"
      mitigation: "Maintain symlinks and deprecation notices for 1 month"
      severity: "high"
      phase: "Phase 3"

    - risk: "Config composition errors after restructuring"
      mitigation: "Comprehensive Hydra composition tests in Phase 6"
      severity: "medium"
      phase: "Phase 2, Phase 3"

    - risk: "Incomplete script updates missing entry points"
      mitigation: "Use ADT MCP tools to find ALL @hydra.main decorators"
      severity: "medium"
      phase: "Phase 5"

    - risk: "Documentation out of sync with implementation"
      mitigation: "Update docs incrementally, validate with users"
      severity: "low"
      phase: "Phase 7"

  rollback_plan:
    - "Git revert to pre-restructure commit"
    - "Symlinks ensure backward compatibility"
    - "Migration guide includes rollback instructions"
    - "Archive branch: feature/hydra-restructure-backup"

  tools_and_resources:
    mcp_tools:
      - "agent-debug-toolkit: Code analysis (find_hydra_usage, analyze_config_access)"
      - "agentqms: Artifact creation and validation"

    cli_tools:
      - "uv: Package management (STRICT: always use 'uv run')"
      - "pytest: Configuration testing"
      - "AgentQMS: Validation and compliance checks"

    documentation:
      - "AGENTS.yaml: Project resource index"
      - "AgentQMS/standards/*.yaml: AI-optimized standards"
      - "project_compass/AGENTS.md: Session protocols"

    references:
      - "Implementation Plan: docs/artifacts/implementation_plans/2026-01-08_0359_implementation_plan_hydra-config-restructuring.md"
      - "Session Handover: project_compass/session_handover.md"
      - "Walkthrough: docs/artifacts/walkthroughs/2026-01-05_0441_Hydra-Config-Architecture-Restructuring.md"

  success_metrics:
    quantitative:
      - "YAML files reduced from 107 to < 60"
      - "Directories reduced from 37 to < 20"
      - "Root configs reduced from 6 to ≤ 5"
      - "Zero configuration composition errors"
      - "100% AgentQMS compliance"

    qualitative:
      - "Improved configuration discoverability"
      - "Simpler entry point usage"
      - "Easier experimentation workflows"
      - "Better documentation clarity"
      - "Positive user feedback on migration"

  timeline:
    estimated_total: "24 hours"
    critical_path:
      - "Phase 0 (Complete) → Phase 1 (2h) → Phase 2 (4h) → Phase 3 (3h+approval)"
      - "Phase 3 → Phase 4 (3h) → Phase 5 (4h) → Phase 6 (3h)"
      - "Phase 6 → Phase 7 (3h) → Phase 8 (2h)"

    milestones:
      - date: "2026-01-08"
        milestone: "Phase 0 Complete - Discovery finished"
      - date: "2026-01-09"
        milestone: "Phase 1-2 Complete - Foundation and domains established"
      - date: "2026-01-09"
        milestone: "Phase 3 Approval - Stakeholder sign-off on breaking changes"
      - date: "2026-01-10"
        milestone: "Phase 4-6 Complete - Implementation and validation done"
      - date: "2026-01-10"
        milestone: "Phase 7-8 Complete - Documentation and CI/CD updated"

  notes: |
    This roadmap tracks the comprehensive restructuring of Hydra configuration
    from a flat, component-based organization to a domain-first hierarchy.

    Key Principles:
    - Minimize breaking changes (concentrated in Phase 3)
    - Maintain backward compatibility via symlinks
    - Use MCP tools for discovery and validation
    - Validate with AgentQMS at each phase
    - Document migration path thoroughly

    Current Status: Phase 0 complete, ready for Phase 1 implementation.
