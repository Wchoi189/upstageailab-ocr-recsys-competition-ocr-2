# Implementation Plan Updates - Registry Automation

**Date**: 2026-01-26  
**Status**: Critical Enhancements Integrated  
**Base Plan**: [registry-automation-plan.md](./registry-automation-plan.md)

## Summary of Updates

Based on architectural review feedback, the following critical enhancements have been integrated into the implementation plan:

### 1. **Phase 0 Added: Nuclear Archive Approach**

**Rationale**: Start with a clean slate to ensure 100% v2.0 compliance from day one.

**Action**:
```bash
# Archive all legacy standards
mkdir -p AgentQMS/standards/_archive
mv AgentQMS/standards/tier*/*.yaml AgentQMS/standards/_archive/
cp AgentQMS/standards/registry.yaml AgentQMS/standards/_archive/registry.yaml.backup
```

**Protocol**: No file exits archive unless it passes strict v2.0 validation.

**Benefits**:
- Zero legacy debt
- Clean testing environment
- Safe rollback path
- Surgical file reintroduction

---

### 2. **ADS Schema Upgraded to v2.0**

**Key Additions**:

#### `id` Field (Required)
- Unique kebab-case identifier for dependency mapping
- Pattern: `^[a-z0-9-]+$`
- Example: `"naming-conventions"`, `"python-core"`, `"hydra-v5-rules"`
- **Purpose**: Enable dependency graph building

#### `dependencies` Field (Optional Array)
```json
{
  "dependencies": ["naming-conventions", "file-placement-rules"]
}
```
- List of standard IDs that must be loaded together
- Ensures Tier 1 constitutional laws are never forgotten
- Enables automatic dependency expansion in resolver

#### `fuzzy_threshold` Field (Optional Int)
```json
{
  "fuzzy_threshold": 80
}
```
- Levenshtein similarity threshold for keyword matching (0-100)
- Default: 80
- **Purpose**: Enable fuzzy search ("hidra config" → "hydra-v5-rules")

**Schema Version**: `"ads_version": "2.0"`

---

### 3. **Registry Compiler Enhanced (Task 1.2)**

**Original Effort**: 12 hours  
**Updated Effort**: 18 hours (6 hours added for enhancements)

#### New Features Added:

##### A. **Strict Mode Enforcement**
```python
def _extract_ads_header(self, file_path: Path) -> Dict[str, Any]:
    # In strict mode, missing headers cause compilation failure
    if not header:
        if self.strict_mode:
            raise SystemExit(f"[STRICT:FAIL] {file_path}: Missing ADS header")
```

**Benefit**: Zero untracked standards can exist (Success Criterion SC-011)

##### B. **Cycle Detection**
```python
def _detect_cycles(self) -> List[str]:
    # DFS-based cycle detection
    # Returns: ["standard-a -> standard-b -> standard-a"]
```

**Algorithm**: Depth-first search on dependency graph  
**Benefit**: Prevents resolver crashes from circular dependencies  
**Error Message**: `[CYCLE:FAIL] Circular dependencies detected: A -> B -> A`

##### C. **Visual Graph Generation**
```python
def _generate_dot_graph(self):
    # Generates architecture_map.dot
    # Tier 1 = gold, Tier 2 = green, Tier 3 = blue, Tier 4 = gray
```

**Output**: `AgentQMS/standards/architecture_map.dot`  
**Usage**: `dot -Tpng architecture_map.dot -o architecture.png`  
**Benefit**: Visual inspection of standard hierarchy and dependencies

##### D. **Semantic Diff (Pulse Delta)**
```python
def _print_semantic_diff(self, new_registry: Dict[str, Any]):
    # Prints what changed since last sync
    # [+] Added: task_id
    # [-] Removed: task_id  
    # [Δ] Modified: task_id (triggers updated)
```

**Benefit**: High visibility into system evolution during multi-turn conversations

##### E. **Auto-Generated Header Comment**
```yaml
# AgentQMS Standards Registry
description: 'AUTO-GENERATED BY sync_registry.py - DO NOT EDIT MANUALLY'
```

**Benefit**: Clear visual warning against manual edits

---

### 4. **Resolution Tool Enhanced (Phase 2)**

**Original Effort**: 10 hours  
**Updated Effort**: 16 hours (6 hours added for enhancements)

#### New Features Added:

##### A. **Fuzzy Keyword Matching**
```python
from rapidfuzz import process, fuzz

def resolve_by_keywords(self, query: str, threshold: int = 80):
    # Uses Levenshtein distance for error-tolerant matching
    results = process.extract(
        query, 
        keywords, 
        scorer=fuzz.WRatio, 
        score_cutoff=threshold
    )
```

**Examples**:
- `"hidra config"` → finds `hydra-v5-rules.yaml`
- `"namingg conventions"` → finds `naming-conventions.yaml`
- `"ocr geomtry"` → finds `ocr-geometry.yaml`

**Dependency**: Requires `rapidfuzz` package

##### B. **Binary Caching**
```python
def _load_with_cache(self):
    # Check if .ads_cache.pickle is newer than registry.yaml
    if cache_exists and cache_newer:
        return pickle.load(cache)
    # Otherwise parse and cache
```

**Performance**: Sub-10ms resolution (vs. 50-100ms without cache)  
**Cache Invalidation**: Automatic when registry.yaml timestamp changes

##### C. **Dependency Expansion**
```python
def _expand_dependencies(self, standard_paths: Set[str]) -> List[str]:
    # Recursively inject required dependencies
    # If "python-core" depends on "naming-conventions",
    # both are returned when querying for "python-core"
```

**Benefit**: Tier 1 constitutional laws automatically included with Tier 2/3/4 standards

##### D. **Agent-Piping CLI Flag**
```bash
# Old way (JSON output)
aqms resolve-standards --task config_files
# {"resolved_standards": [...], "count": 3}

# New way (paths only for piping)
aqms resolve-standards --task config_files --paths-only
# AgentQMS/standards/tier2-framework/hydra-v5-rules.yaml AgentQMS/...

# Agent usage
cat $(aqms resolve-standards --query "ocr geometry" --paths-only)
```

**Benefit**: Agents can instantly ingest context in one command

---

### 5. **New Tool: ML-Aided Migration (Task 3.1 Enhanced)**

**New File**: `AgentQMS/tools/suggest_header.py`  
**Effort**: 12 hours (NEW)

#### Purpose
Automatically generate v2.0 ADS headers for archived legacy files using:
- TF-IDF keyword extraction
- Path-based tier inference
- Legacy registry trigger recovery

#### Features

##### A. **Legacy Trigger Recovery**
```python
def _find_legacy_triggers(self, file_path: str) -> Dict:
    # Extract triggers from old 441-line registry
    # Preserves all keywords and path_patterns from manual version
```

**Benefit**: Parity verification - no knowledge lost during migration

##### B. **Tier Inference**
```python
def _infer_tier(self, file_path: Path) -> int:
    # "tier1-sst/" → 1
    # "tier2-framework/" → 2
    # Default → 2 (Framework)
```

##### C. **Keyword Extraction (TF-IDF Lite)**
```python
def _extract_keywords(self, text: str, top_n: int = 8) -> List[str]:
    # Frequency-based analysis
    # Filters stop words: "the", "and", "should", "must", etc.
```

**Output**: 8 most relevant keywords for trigger generation

##### D. **Automatic Dependency Injection**
```python
"dependencies": ["naming-conventions"] if tier > 1 else []
```

**Rule**: All non-SST standards automatically depend on `naming-conventions`

#### Usage

```bash
# Preview generated header
python AgentQMS/tools/suggest_header.py _archive/old-file.yaml

# Apply header and move to active tier
python AgentQMS/tools/suggest_header.py _archive/old-file.yaml --apply

# Batch process (future enhancement)
find _archive/ -name "*.yaml" | xargs -I {} python AgentQMS/tools/suggest_header.py {} --apply
```

---

### 6. **New Task: Parity Verification (Task 5.2 Enhanced)**

**Effort**: 4 hours (NEW subtask)  
**File**: `AgentQMS/tools/verify_parity.py`

#### Purpose
Compare old manual registry with new auto-generated registry to ensure zero data loss.

#### Checks
1. **Task Coverage**: All tasks from old registry present in new
2. **Keyword Preservation**: All keywords from old triggers present in new
3. **Path Pattern Matching**: All glob patterns preserved
4. **Standard Count**: Number of standards matches or increases (never decreases)

#### Output
```
=== PARITY VERIFICATION ===
✅ Task coverage: 100% (15/15 tasks migrated)
✅ Keyword preservation: 100% (342/342 keywords present)
✅ Path patterns: 100% (89/89 patterns preserved)
✅ Standard count: 71 → 71 (no data loss)

[PASS] Migration achieved 100% parity
```

**Acceptance**: 100% parity score required before Phase 5 completion

---

## Updated Timeline

| Phase | Duration | Key Deliverables | Updated Effort |
|-------|----------|-----------------|----------------|
| **Phase 0** | Pre-Week 1 | Archive all standards, backup registry | **2 hours (NEW)** |
| Phase 1 | Week 1-2 | v2.0 schema, enhanced compiler, tests | **28 hours (+10)** |
| Phase 2 | Week 2-3 | Fuzzy resolver, caching, agent integration | **26 hours (+8)** |
| Phase 3 | Week 3-4 | ML-aided migration tool, pilot migration | **30 hours (+16)** |
| Phase 4 | Week 4-5 | CLI, hooks, CI, agent prompts | **20 hours (same)** |
| Phase 5 | Week 5-6 | Full migration, parity check, testing, rollout | **24 hours (+4)** |

**Total Updated Effort**: ~128 hours (+40 hours for enhancements)

---

## Critical Implementation Notes

### Code Examples Are Templates
⚠️ **Important**: All Python code in the plan is **example code** and may require adjustments:
- Error handling may need refinement
- Type hints should be verified
- Edge cases should be tested thoroughly
- Performance optimizations may be needed
- Dependencies (`rapidfuzz`, `jsonschema`) must be added to `pyproject.toml`

### Testing Requirements Enhanced

**Phase 1 Tests** (now include):
- Strict mode enforcement (files without headers rejected)
- Cycle detection (A→B→A caught and reported)
- DOT graph generation (valid GraphViz syntax)
- Semantic diff accuracy (correct delta reporting)

**Phase 2 Tests** (now include):
- Fuzzy matching threshold tuning (80% default, adjustable)
- Cache invalidation (registry.yaml change triggers rebuild)
- Dependency expansion (recursive inclusion)
- Paths-only CLI output (space-separated, pipeable)

**Phase 3 Tests** (now include):
- Legacy trigger recovery (100% accuracy vs. old registry)
- Tier inference (correct classification from path)
- Keyword extraction quality (relevant terms selected)
- Parity verification (zero data loss confirmed)

---

## Updated Success Metrics

### Quantitative (Enhanced)
- ✅ Registry 100% auto-generated (0 manual edits after rollout)
- ✅ Agent context reduced 80% (1000 → 200 tokens)
- ✅ Registry compilation time <5s (with caching: <10ms resolution)
- ✅ Resolution query latency <100ms (with cache: <10ms)
- ✅ All 71 standards migrated with valid v2.0 headers
- ✅ Pre-commit validation blocks 100% of invalid standards
- ✅ **Zero untracked files** (SC-011: strict mode enforcement)
- ✅ **Zero circular dependencies** (compile-time detection)
- ✅ **100% parity** with legacy registry (verified migration)

### Qualitative (Enhanced)
- Visual architecture graph enables system understanding
- Pulse delta provides real-time drift visibility
- Fuzzy matching reduces agent query precision requirements
- ML-aided migration reduces manual effort by 90%+

---

## Risk Assessment Updates

### New Risk 1: Strict Mode Too Aggressive
**Impact**: Medium  
**Probability**: Low  
**Mitigation**:
- Provide `--no-strict` flag for development
- Clear error messages guide fixes
- Archive strategy allows incremental migration

### New Risk 2: Fuzzy Matching False Positives
**Impact**: Low  
**Probability**: Medium  
**Mitigation**:
- Tunable threshold (80% default)
- Agents can override with explicit task IDs
- Parity verification catches mismatches

### New Risk 3: Dependency Cycles Discovered Late
**Impact**: High  
**Probability**: Low  
**Mitigation**:
- Cycle detection in Phase 1 (early)
- Caught before any file promotion from archive
- DOT graph visualizes dependencies

---

## Next Steps

### Immediate Actions
1. **Review v2.0 schema** - Ensure `id`, `dependencies`, `fuzzy_threshold` fields meet needs
2. **Install dependencies** - Add `rapidfuzz`, `jsonschema` to `pyproject.toml`
3. **Execute Phase 0** - Archive all standards (REVERSIBLE action)
4. **Begin Phase 1, Task 1.1** - Create `ads-header.json` v2.0 schema

### Validation Checkpoints
- **After Phase 1**: Run dry-run compilation on empty archive
- **After Phase 2**: Benchmark cache performance (<10ms target)
- **After Phase 3**: Run parity verification (100% score required)
- **Before Phase 5**: Final rollout decision based on all metrics

---

## Questions & Clarifications

### Q: Is the nuclear approach too aggressive?
**A**: The archive is non-destructive. All files remain in `_archive/` and can be rolled back instantly. This approach ensures clean state and thorough testing.

### Q: What if we discover issues with v2.0 schema mid-migration?
**A**: Schema changes are isolated to `ads-header.json`. The validator rejects non-compliant files immediately, preventing propagation. Rollback is one git commit.

### Q: How do we handle 71 files efficiently?
**A**: The `suggest_header.py` ML-aide automates 90% of header generation. Manual review required only for edge cases. Estimated: 5 minutes per file = ~6 hours total for 71 files.

### Q: What if parity verification fails?
**A**: Migration pauses. Use diff output to identify missing triggers. Adjust `suggest_header.py` logic or manually supplement headers. Re-run verification until 100%.

---

## References

- **Main Plan**: [registry-automation-plan.md](./registry-automation-plan.md)
- **Specification**: [specs/001-registry-automation/spec.md](../../specs/001-registry-automation/spec.md)
- **Draft Research**: [__DEBUG__/2026-01-25_standards-update/additional-updates/draft-research.md](../../__DEBUG__/2026-01-25_standards-update/additional-updates/draft-research.md)
- **Architecture Philosophy**: [AgentQMS/standards/tier1-sst/ai-native-architecture.md](../../AgentQMS/standards/tier1-sst/ai-native-architecture.md)

---

**Status**: Updates integrated, ready for Phase 0 execution  
**Last Updated**: 2026-01-26  
**Review Required**: Yes (before Phase 0 archive action)
