---
ads_version: "1.0"
type: rule_set
title: Hydra Configuration Architecture
agent: all
tier: 2
priority: critical
validates_with: "AgentQMS/standards/schemas/compliance-checker.py"
compliance_status: pass
memory_footprint: 680
date: "2026-01-08"
status: active
id: hydra-config-architecture
migration_completed: "2026-01-08"
baseline: {yaml_files: 107, directories: 37, root_configs: 6}
current: {yaml_files: 112, directories: 41, root_configs: 7}

# Hydra Configuration Architecture (Domain-First Organization)

structure:
  entry_points:
    - train.yaml        # Universal training (domain switchable via domain=X)
    - eval.yaml         # Testing/evaluation (renamed from test.yaml)
    - predict.yaml      # Inference
    - synthetic.yaml    # Synthetic data generation
    - train_kie.py      # KIE training (uses train.yaml with domain=kie)

  core_directories:
    _foundation:
      purpose: "Core composition fragments"
      files:
        - defaults.yaml       # Base defaults (replaces base.yaml)
        - core.yaml          # Core experiment settings
        - data.yaml          # Data composition defaults
        - model.yaml         # Model composition defaults
        - trainer.yaml       # Lightning trainer settings
        - logging.yaml       # Logger configuration
        - preprocessing.yaml # Preprocessing settings

    domain:
      purpose: "Multi-domain unified configs"
      files:
        - detection.yaml     # Text detection (DBNet family)
        - recognition.yaml   # Text recognition (PARSeq)
        - kie.yaml          # Key information extraction (LayoutLMv3)
        - layout.yaml       # Layout analysis

    model:
      purpose: "Architecture components"
      subdirs: [architectures, decoder, encoder, head, loss, optimizers, presets, recognition, lightning_modules]

    data:
      purpose: "Dataset configurations"
      subdirs: [dataloaders, datasets, performance_preset, transforms]

    training:
      purpose: "Training infrastructure"
      subdirs: [callbacks, logger, profiling]
      note: "Consolidated from callbacks/, logger/, ui/, ui_meta/"

    __EXTENDED__:
      purpose: "Edge cases, experiments, archived configs"
      subdirs: [kie_variants, benchmarks, examples, experiments]

    __LEGACY__:
      purpose: "Deprecated configurations (read-only)"
      subdirs: [data, model]

# Configuration Registry

config_registry:
  entry_points:
    train.yaml:
      purpose: "Universal training entry point"
      domain_switching: true
      default_domain: detection
      breaking_changes_date: "2026-01-08"
      migration_from: [train_kie.yaml, train_kie_aihub.yaml, train_kie_merged.yaml]
      runner: "runners/train.py"

    eval.yaml:
      purpose: "Testing and evaluation"
      renamed_from: test.yaml
      rename_date: "2026-01-08"
      runner: "runners/test.py"

    predict.yaml:
      purpose: "Inference and prediction"
      runner: "runners/predict.py"

    synthetic.yaml:
      purpose: "Synthetic data generation"
      runner: "runners/generate_synthetic.py"

  domain_configs:
    domain/detection.yaml:
      domain: detection
      task_type: text_detection
      models: [DBNet, DBNet++, CRAFT]
      created: "2026-01-08"
      description: "Text detection in document images"

    domain/recognition.yaml:
      domain: recognition
      task_type: text_recognition
      models: [PARSeq]
      created: "2026-01-08"
      description: "Text recognition (OCR) from text regions"

    domain/kie.yaml:
      domain: kie
      task_type: key_information_extraction
      models: [LayoutLMv3]
      created: "2026-01-08"
      description: "Key information extraction from documents"
      features: [ocr_tokens, layout_features, visual_features]

    domain/layout.yaml:
      domain: layout
      task_type: layout_analysis
      created: "2026-01-08"
      description: "Document layout analysis and segmentation"

  archived_configs:
    __EXTENDED__/kie_variants/:
      contents: [train_kie.yaml, train_kie_aihub.yaml, train_kie_aihub_only.yaml, train_kie_aihub_production.yaml, train_kie_baseline_optimized_v2.yaml, train_kie_merged_3090_10ep.yaml]
      migration_date: "2026-01-08"
      replacement: "train.yaml with domain=kie"
      still_functional: true

    __EXTENDED__/examples/:
      contents: [predict_shadow_removal.yaml]
      migration_date: "2026-01-08"

    __EXTENDED__/experiments/:
      contents: [train_v2.yaml]
      migration_date: "2026-01-08"

# Domain Switching Rules

domain_switching:
  mechanism: "Hydra defaults composition via optional domain parameter"
  syntax:
    - "python runners/train.py domain=detection"
    - "python runners/train.py domain=recognition"
    - "python runners/train.py domain=kie"
    - "python runners/train.py domain=layout"

  train_yaml_structure: |
    defaults:
      - _self_
      - base
      - optional domain: detection  # Default domain
      - /_foundation/model
      - /_foundation/data
      - /_foundation/trainer

  domain_configs:
    detection:
      task_type: detection
      model: DBNet/DBNet++ family
      datasets: Text detection datasets

    recognition:
      task_type: recognition
      model: PARSeq (Vision Transformer)
      datasets: Text recognition datasets

    kie:
      task_type: kie
      model: LayoutLMv3
      datasets: Receipt/document KIE datasets
      special: {use_ocr_features: true, use_layout_features: true}

    layout:
      task_type: layout_analysis
      model: Layout analysis models
      datasets: Document layout datasets

# Override Patterns (Golden Rule)

override_rules:
  base_defaults_check:
    rule: "Check if config group exists in base.yaml defaults list"
    in_defaults: "Override WITHOUT + prefix"
    not_in_defaults: "Override WITH + prefix"

  examples:
    without_plus:
      - "model=craft"                    # model is in base.yaml defaults
      - "data=canonical"                 # data is in base.yaml defaults
      - "trainer=rtx3060_12gb"          # trainer is in base.yaml defaults
      - "domain=kie"                     # domain is optional in train.yaml

    with_plus:
      - "+debug=default"                 # debug NOT in base.yaml defaults
      - "+extraction=hybrid"             # extraction NOT in base.yaml defaults
      - "+data/datasets=db"             # Nested group addition

  hydra_overrides:
    syntax: "++key=value"
    use_case: "Override config values directly"
    examples:
      - "++model.optimizer.lr=0.0001"
      - "++batch_size=16"
      - "++seed=123"

# Defaults List Ordering Rules

defaults_ordering:
  critical_rule: "Overrides MUST be at the end of defaults list"

  correct_order:
    - "_self_"
    - "base"
    - "regular defaults (data/transforms, model/presets, etc.)"
    - "override defaults (override data: base, override hydra/...)"

  example_correct: |
    defaults:
      - _self_
      - base
      - data/performance_preset: none
      - data/transforms: base
      - /model/presets/model_example
      - override data: base           # MUST be after regular defaults
      - override hydra/hydra_logging: disabled

  common_error:
    symptom: "ConfigCompositionException: Override 'data : base' is defined before..."
    cause: "Override placed before regular defaults"
    fix: "Move all 'override X: Y' to end of defaults list"

# File Archival Rules

archival_policy:
  deprecated_configs:
    base.yaml:
      status: "Retained temporarily"
      replacement: "_foundation/defaults.yaml"
      removal_trigger: "After migration period (user discretion)"

    test.yaml:
      status: "Renamed → eval.yaml"
      migration_date: "2026-01-08"

    train_kie*.yaml:
      status: "Archived → __EXTENDED__/kie_variants/"
      replacement: "train.yaml with domain=kie"

    predict_shadow_removal.yaml:
      status: "Archived → __EXTENDED__/examples/"

    train_v2.yaml:
      status: "Archived → __EXTENDED__/experiments/"

  legacy_directories:
    callbacks: "Moved → training/callbacks/"
    logger: "Moved → training/logger/"
    ui: "Merged → training/logger/"
    ui_meta: "Merged → training/logger/"
    benchmark: "Archived → __EXTENDED__/benchmarks/"
    examples: "Archived → __EXTENDED__/examples/"

# Entry Point Configuration

entry_point_mapping:
  runners/train.py:
    config_name: "train"
    config_file: "configs/train.yaml"
    domain_switching: true
    usage: "python runners/train.py [domain=X] [overrides...]"

  runners/test.py:
    config_name: "eval"
    config_file: "configs/eval.yaml"
    note: "Renamed from test.yaml"

  runners/predict.py:
    config_name: "predict"
    config_file: "configs/predict.yaml"

  runners/generate_synthetic.py:
    config_name: "synthetic"
    config_file: "configs/synthetic.yaml"

  runners/train_kie.py:
    config_name: "train"
    config_file: "configs/train.yaml"
    note: "Changed from train_kie to train; uses domain composition"

# Common Composition Patterns

composition_patterns:
  basic_training:
    command: "python runners/train.py"
    defaults_used: [base, domain/detection, _foundation/model, _foundation/data, _foundation/trainer]

  domain_switch:
    command: "python runners/train.py domain=kie"
    effect: "Replaces domain/detection with domain/kie"

  model_architecture:
    command: "python runners/train.py model/architectures=dbnetpp"
    effect: "Changes model architecture to DBNet++"

  performance_preset:
    command: "python runners/train.py data/performance_preset=memory_efficient"
    effect: "Applies memory-efficient data loading settings"

  multiple_overrides:
    command: "python runners/train.py domain=recognition model/recognition=parseq data=recognition"
    effect: "Complete configuration switch for recognition task"

# Validation Requirements

validation:
  composition_tests:
    required: true
    test_command: "python runners/X.py --help"
    expected: "No ConfigCompositionException"
    coverage: [train, eval, predict, synthetic, train_kie]

  domain_switching:
    required: true
    domains_to_test: [detection, recognition, kie, layout]
    test_command: "python runners/train.py domain=X --cfg job"
    expected: "Valid composed configuration output"

  smoke_tests:
    required: true
    test_type: "Entry point help messages"
    expected: "All entry points display configuration groups"

# Migration Cheatsheet

migration_map:
  old_to_new:
    "test.yaml": "eval.yaml"
    "base.yaml": "_foundation/defaults.yaml"
    "train_kie.yaml": "train.yaml with domain=kie"
    "callbacks/X.yaml": "training/callbacks/X.yaml"
    "logger/X.yaml": "training/logger/X.yaml"

  common_workflows:
    kie_training_old: "python runners/train_kie.py"
    kie_training_new: "python runners/train_kie.py (now uses train.yaml internally)"

    testing_old: "python runners/test.py"
    testing_new: "python runners/test.py (uses eval.yaml internally)"

    architecture_old: "Edit train_kie.yaml directly"
    architecture_new: "Use domain config: configs/domain/kie.yaml or override via CLI"

# Troubleshooting Rules

troubleshooting:
  config_composition_error:
    error: "ConfigCompositionException"
    cause: "Override defaults not at end of list"
    solution: "Move all 'override X: Y' entries to end of defaults list"

  missing_config_group:
    error: "Could not find 'X'"
    cause: "Config group not in search path or typo"
    solution: "Check configs/ directory structure, verify file exists"

  multiple_values_for_domain:
    error: "Multiple values for domain"
    cause: "Using +domain=X when domain already in defaults"
    solution: "Use domain=X (without +) for override, not addition"

  import_error_after_restructure:
    error: "Config file not found"
    cause: "Files moved during restructuring"
    solution: "Check migration_map above for new locations"

# Performance Considerations

performance:
  config_loading:
    overhead: "Negligible (< 100ms)"
    caching: "Hydra caches composed configs"
    recommendation: "Use domain switching for multi-task training"

  memory_footprint:
    domain_configs: "~5KB each"
    full_composition: "~50KB total"
    optimization: "Lazy loading for unused groups"

# Standards Compliance

compliance:
  agentqms_validated: "2026-01-08"
  compliance_rate: "100%"
  artifacts_valid: "74/74"
  test_coverage: "All entry points verified"
  breaking_changes: "test.yaml → eval.yaml, train_kie configs archived"
