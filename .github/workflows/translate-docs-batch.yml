name: Translate Technical Documents (Batch)

on:
  workflow_dispatch:
    inputs:
      documents:
        description: 'Which documents to translate'
        required: true
        type: choice
        options:
          - 'All documents'
          - 'Bug reports only'
          - 'Experiment reports only'
          - 'Assessments only'
        default: 'All documents'

jobs:
  translate-docs:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 3  # Limit concurrent API calls to avoid rate limits
      matrix:
        include:
          # Bug Reports
          - file: 'docs/artifacts/bug_reports/2026-01-04_1730_BUG_003_config-precedence-leak.md'
            category: 'bug-report'

          # Assessments
          - file: 'docs/artifacts/assessments/2026-01-03_1200_assessment-layoutlmv3-kie-receipt-failure.md'
            category: 'assessment'

          # Experiment Reports
          - file: 'experiment_manager/experiments/20251122_172313_perspective_correction/artifacts/20251122_1723_assessment_200-image-test-results.md'
            category: 'experiment'

          - file: 'experiment_manager/experiments/20251220_154834_zero_prediction_images_debug/README.md'
            category: 'experiment'

          - file: 'experiment_manager/experiments/20251129_173500_perspective_correction_implementation/.metadata/assessments/20251129_1735_assessment_test-results-analysis.md'
            category: 'experiment'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if should translate
        id: check
        run: |
          SELECTION="${{ github.event.inputs.documents }}"
          CATEGORY="${{ matrix.category }}"

          SHOULD_TRANSLATE="false"

          if [ "$SELECTION" = "All documents" ]; then
            SHOULD_TRANSLATE="true"
          elif [ "$SELECTION" = "Bug reports only" ] && [ "$CATEGORY" = "bug-report" ]; then
            SHOULD_TRANSLATE="true"
          elif [ "$SELECTION" = "Experiment reports only" ] && [ "$CATEGORY" = "experiment" ]; then
            SHOULD_TRANSLATE="true"
          elif [ "$SELECTION" = "Assessments only" ] && [ "$CATEGORY" = "assessment" ]; then
            SHOULD_TRANSLATE="true"
          fi

          echo "should_translate=$SHOULD_TRANSLATE" >> $GITHUB_OUTPUT

      - name: Set up Python
        if: steps.check.outputs.should_translate == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        if: steps.check.outputs.should_translate == 'true'
        run: |
          pip install openai python-dotenv

      - name: Translate document to Korean
        if: steps.check.outputs.should_translate == 'true'
        id: translate
        env:
          UPSTAGE_API_KEY: ${{ secrets.UPSTAGE_API_KEY }}
        run: |
          python scripts/data/translate_document.py --recursive "${{ matrix.file }}"

      - name: Save Korean translation metadata
        if: steps.check.outputs.should_translate == 'true'
        run: |
          FILE="${{ matrix.file }}"
          dir=$(dirname "$FILE")
          base=$(basename "$FILE" .md)

          # Special handling for README files in experiment directories
          if [ "$base" = "README" ]; then
            output="${dir}/README.ko.md"
          else
            output="${dir}/${base}.ko.md"
          fi

          # Script writes the file directly, we just define output var for metadata

          # Add translation metadata
          cat > "${output}.meta" << EOF
          ---
          translation_date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          source_file: $FILE
          translator: Upstage Solar Pro 2
          workflow_run: ${{ github.run_id }}
          ---
          EOF

          echo "Translated: $FILE â†’ $output"

      - name: Commit translation
        if: steps.check.outputs.should_translate == 'true'
        env:
          FILE_PATH: ${{ matrix.file }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Add the specific translated files (unquoted for glob expansion)
          # Use || true to suppress error if no files match, but we want to capture real errors?
          # Actually, if no files match, git add fails. We want to avoid that if translation failed silently (but we fixed the script now).
          # Still, safest to try/catch

          if git add *.ko.md *.ko.md.meta 2>/dev/null; then
             if ! git diff --staged --quiet; then
               git commit -m "docs: add Korean translation for ${FILE_PATH} [skip ci]"

               # Pull changes before pushing to avoid conflicts
               git pull --rebase origin main

               # Retry push with pull in case of concurrent updates
               for i in {1..5}; do
                 if git push; then
                   echo "âœ… Push successful"
                   break
                 else
                   echo "âš ï¸ Push failed, attempt $i/5. Pulling and retrying..."
                   git pull --rebase origin main
                   sleep $((i * 2))
                 fi
               done
             else
               echo "No changes to commit"
             fi
          else
             echo "No localized files found to add."
          fi

  summary:
    needs: translate-docs
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Translation Summary
        run: |
          echo "## Translation Batch Complete ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Selection: ${{ github.event.inputs.documents }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Korean translations have been generated and committed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the generated \`.ko.md\` files" >> $GITHUB_STEP_SUMMARY
          echo "2. Check translation quality for technical terms" >> $GITHUB_STEP_SUMMARY
          echo "3. Update README.md links to include Korean versions" >> $GITHUB_STEP_SUMMARY
