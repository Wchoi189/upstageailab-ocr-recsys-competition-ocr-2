<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; style-src 'unsafe-inline'; script-src 'nonce-{{nonce}}';">
    <title>MCP Visibility Dashboard</title>
    <style>
        :root {
            --bg-primary: var(--vscode-editor-background);
            --bg-secondary: var(--vscode-sideBar-background);
            --bg-elevated: var(--vscode-editorWidget-background);
            --text-primary: var(--vscode-editor-foreground);
            --text-muted: var(--vscode-descriptionForeground);
            --border: var(--vscode-panel-border);
            --border-light: var(--vscode-widget-border);
            --success: #4caf50;
            --error: #f44336;
            --warning: #ff9800;
            --info: #2196f3;
            --accent: var(--vscode-focusBorder);
            --hover: var(--vscode-list-hoverBackground);
            --shadow: rgba(0, 0, 0, 0.2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--text-primary);
            background: var(--bg-primary);
            padding: 16px;
        }

        h1 {
            font-size: 1.4em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .health-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
        }

        .health-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .health-indicator.connected {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .health-indicator.disconnected {
            background: var(--error);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .last-update {
            color: var(--text-muted);
            font-size: 0.75em;
            margin-top: 2px;
        }

        .refresh-btn {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .refresh-btn:hover {
            background: var(--vscode-button-hoverBackground);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .stat-value.success {
            color: var(--success);
        }

        .stat-value.error {
            color: var(--error);
        }

        .stat-value.warning {
            color: var(--warning);
        }

        .stat-value.info {
            color: var(--info);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.85em;
            margin-top: 4px;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.1em;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .log-table th,
        .log-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .log-table th {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .status-success {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        .status-error {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
        }

        .status-policy_violation {
            background: rgba(255, 152, 0, 0.2);
            color: var(--warning);
        }

        .violations-panel {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 12px;
        }

        .violation-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 152, 0, 0.3);
        }

        .violation-item:last-child {
            border-bottom: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .tool-name {
            font-family: var(--vscode-editor-font-family);
        }

        .time-ago {
            color: var(--text-muted);
            font-size: 0.85em;
        }

        .bundles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .bundle-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
        }

        .bundle-name {
            font-weight: 600;
            color: var(--info);
            margin-bottom: 4px;
        }

        .bundle-desc {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .bundle-files {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 10px 16px;
            font-size: 0.9em;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s ease;
            position: relative;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--hover);
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .search-input:focus {
            outline: 1px solid var(--accent);
            border-color: var(--accent);
        }

        .filter-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: 1px solid var(--accent);
        }

        .toolbar-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 14px;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toolbar-btn:hover {
            background: var(--hover);
            border-color: var(--accent);
        }

        /* Enhanced Cards */
        .stat-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 4px var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        /* Tool Analytics Grid */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .tool-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 14px;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .tool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .tool-usage {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .tool-badge {
            background: var(--info);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }

        /* Settings Panel */
        .settings-panel {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-weight: 500;
        }

        .setting-description {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .toggle-switch {
            width: 40px;
            height: 20px;
            background: var(--bg-secondary);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: background 0.3s;
        }

        .toggle-switch.on {
            background: var(--success);
        }

        .toggle-knob {
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 1px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.on .toggle-knob {
            left: 20px;
        }

        /* Empty state improvements */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Modal Dialog */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px var(--shadow);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.1em;
            font-weight: 600;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .detail-group {
            margin-bottom: 20px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.85em;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .detail-value {
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-family: var(--vscode-editor-font-family);
            font-size: 0.9em;
        }

        .detail-value.code {
            white-space: pre-wrap;
            word-break: break-all;
        }

        .clickable-row {
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .clickable-row:hover {
            background: var(--hover) !important;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input {
                min-width: 100%;
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
            }
        }
    </style>
</head>

<body>
    <div class="header-row">
        <h1>
            <span>üìä AgentQMS Visibility</span>
            <button class="refresh-btn" onclick="refresh()">‚Üª Refresh</button>
        </h1>
        <div class="health-status">
            <div class="health-indicator disconnected" id="healthIndicator"></div>
            <span id="healthText">Connecting...</span>
        </div>
    </div>
    <div class="last-update" id="lastUpdate">Last update: Never</div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" data-tab="overview">üìä Overview</button>
        <button class="tab-btn" data-tab="tools">üîß Tools</button>
        <button class="tab-btn" data-tab="tools">üîß Tools</button>
        <button class="tab-btn" data-tab="policies">üìú Policies</button>
        <button class="tab-btn" data-tab="bundles">üì¶ Bundles</button>
        <button class="tab-btn" data-tab="settings">‚öôÔ∏è Settings</button>
    </div>

    <!-- Overview Tab -->
    <div class="tab-content active" id="tab-overview">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value info" id="total">0</div>
                <div class="stat-label">Total Calls</div>
            </div>
            <div class="stat-card">
                <div class="stat-value success" id="success">0</div>
                <div class="stat-label">Successful</div>
            </div>
            <div class="stat-card">
                <div class="stat-value error" id="errors">0</div>
                <div class="stat-label">Errors</div>
            </div>
            <div class="stat-card">
                <div class="stat-value warning" id="violations">0</div>
                <div class="stat-label">Policy Violations</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgDuration">0</div>
                <div class="stat-label">Avg Duration (ms)</div>
            </div>
        </div>

        <div class="section" id="violations-section" style="display: none;">
            <h2 class="section-title">‚ö†Ô∏è Recent Policy Violations</h2>
            <div class="violations-panel" id="violations-list"></div>
        </div>

        <div class="section">
            <h2 class="section-title">üìã Recent Tool Calls</h2>
            <div class="toolbar">
                <input type="search" class="search-input" placeholder="Search tool calls..." id="searchInput">
                <select class="filter-select" id="statusFilter">
                    <option value="all">All Statuses</option>
                    <option value="success">Success</option>
                    <option value="error">Error</option>
                    <option value="policy_violation">Violations</option>
                </select>
                <button class="toolbar-btn" onclick="exportData()">üì• Export</button>
            </div>
            <div id="calls-container">
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <div>No telemetry data yet. Make some MCP tool calls!</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tools Tab -->
    <div class="tab-content" id="tab-tools">
        <div class="section">
            <h2 class="section-title">üîß Tool Analytics</h2>
            <div class="toolbar">
                <input type="search" class="search-input" placeholder="Search tools..." id="toolSearch">
                <select class="filter-select" id="toolSortBy">
                    <option value="usage">Sort by Usage</option>
                    <option value="name">Sort by Name</option>
                    <option value="avgDuration">Sort by Avg Duration</option>
                </select>
            </div>
            <div class="tools-grid" id="tools-grid">
                <div class="empty-state">
                    <div class="empty-state-icon">üîß</div>
                    <div>No tool data available</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Policies Tab (Merged with Violations) -->
    <div class="tab-content" id="tab-policies">
        <!-- Violations Section -->
        <div class="section">
            <h2 class="section-title">‚ö†Ô∏è Compliance Status</h2>
            <div id="violations-detailed">
                <div class="empty-state">
                    <div class="empty-state-icon">‚úì</div>
                    <div>No policy violations found</div>
                </div>
            </div>
        </div>

        <!-- Standards Section -->
        <div class="section">
            <h2 class="section-title">üìú Active Standards & Policies</h2>
            <div class="toolbar">
                <input type="search" class="search-input" placeholder="Search policies..." id="policySearch">
            </div>
            <div id="policies-container">
                <div class="empty-state">
                    <div class="empty-state-icon">üìú</div>
                    <div>No policies found</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bundles Tab -->
    <div class="tab-content" id="tab-bundles">
        <div class="section">
            <h2 class="section-title">üì¶ Context Bundles</h2>
            <div class="toolbar">
                <input type="search" class="search-input" placeholder="Search bundles..." id="bundleSearch">
            </div>
            <div id="bundles-container">
                <div class="empty-state">
                    <div class="empty-state-icon">üì¶</div>
                    <div>No bundles found</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-content" id="tab-settings">
        <div class="section">
            <h2 class="section-title">‚öôÔ∏è Dashboard Settings</h2>
            <div class="settings-panel">
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Auto Refresh</div>
                        <div class="setting-description">Automatically refresh data when telemetry updates</div>
                    </div>
                    <div class="toggle-switch on" onclick="toggleSetting(this, 'autoRefresh')">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Show Notifications</div>
                        <div class="setting-description">Show notifications for errors and violations</div>
                    </div>
                    <div class="toggle-switch on" onclick="toggleSetting(this, 'notifications')">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Compact View</div>
                        <div class="setting-description">Use compact layout for tables</div>
                    </div>
                    <div class="toggle-switch" onclick="toggleSetting(this, 'compactView')">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
            </div>

            <div class="settings-panel">
                <h3 style="margin-bottom: 12px;">Data Management</h3>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Max Events Displayed</div>
                        <div class="setting-description">Currently showing last 100 events</div>
                    </div>
                    <select class="filter-select" onchange="updateMaxEvents(this.value)">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                    </select>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Clear All Data</div>
                        <div class="setting-description">Reset all cached telemetry data</div>
                    </div>
                    <button class="toolbar-btn" onclick="clearData()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Dialog -->
    <div class="modal-overlay" id="modal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Tool Call Details</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <script nonce="{{nonce}}">
        const vscode = acquireVsCodeApi();
        let currentData = { recentCalls: [], total: 0 };
        let settings = {
            autoRefresh: true,
            notifications: true,
            compactView: false,
            maxEvents: 100
        };

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                switchTab(tabName);
            });
        });

        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Load tab-specific data
            if (tabName === 'tools') {
                updateToolsTab();
            } else if (tabName === 'policies') {
                updateViolationsTab();
                // updatePoliciesTab is handled by message updates, but we should ensure it renders
                // We'll rely on the existing data or trigger a render if we have it
                if (window.lastPolicies) {
                    updatePoliciesList(window.lastPolicies);
                }
            }
        }

        function refresh() {
            vscode.postMessage({ command: 'refresh' });
        }

        function formatTimeAgo(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);

            if (diffSec < 60) return diffSec + 's ago';
            if (diffSec < 3600) return Math.floor(diffSec / 60) + 'm ago';
            if (diffSec < 86400) return Math.floor(diffSec / 3600) + 'h ago';
            return date.toLocaleDateString();
        }

        function updateConnectionStatus(connected, error) {
            const indicator = document.getElementById('healthIndicator');
            const text = document.getElementById('healthText');
            const lastUpdate = document.getElementById('lastUpdate');

            if (connected) {
                indicator.className = 'health-indicator connected';
                text.textContent = 'Connected';
            } else {
                indicator.className = 'health-indicator disconnected';
                text.textContent = error || 'Disconnected';
            }

            lastUpdate.textContent = 'Last update: ' + new Date().toLocaleTimeString();
        }

        function updateDashboard(data) {
            currentData = data;

            document.getElementById('total').textContent = data.total;
            document.getElementById('success').textContent = data.success;
            document.getElementById('errors').textContent = data.errors;
            document.getElementById('violations').textContent = data.policyViolations;
            document.getElementById('avgDuration').textContent = data.avgDurationMs;

            // Update last update time
            document.getElementById('lastUpdate').textContent = 'Last update: ' + new Date().toLocaleTimeString();

            // Violations panel
            const violationsSection = document.getElementById('violations-section');
            const violationsList = document.getElementById('violations-list');
            const violations = data.recentCalls.filter(c => c.status === 'policy_violation');

            if (violations.length > 0) {
                violationsSection.style.display = 'block';
                violationsList.innerHTML = violations.slice(0, 5).map(v =>
                    '<div class="violation-item"><strong class="tool-name">' + v.tool_name + '</strong>: ' +
                    (v.policy || 'Unknown policy') +
                    ' <span class="time-ago">' + formatTimeAgo(v.timestamp) + '</span></div>'
                ).join('');
            } else {
                violationsSection.style.display = 'none';
            }

            // Recent calls table
            const container = document.getElementById('calls-container');
            if (data.recentCalls.length === 0) {
                container.innerHTML = '<div class="empty-state">No telemetry data yet. Make some MCP tool calls!</div>';
                return;
            }

            container.innerHTML = '<table class="log-table">' +
                '<thead><tr><th>Tool</th><th>Status</th><th>Duration</th><th>Time</th></tr></thead>' +
                '<tbody>' +
                data.recentCalls.map(call =>
                    '<tr>' +
                    '<td class="tool-name">' + call.tool_name + '</td>' +
                    '<td><span class="status-badge status-' + call.status + '">' + call.status + '</span></td>' +
                    '<td>' + (call.duration_ms ? call.duration_ms + 'ms' : '-') + '</td>' +
                    '<td class="time-ago">' + formatTimeAgo(call.timestamp) + '</td>' +
                    '</tr>'
                ).join('') +
                '</tbody></table>';
        }

        function updateBundles(bundles) {
            const container = document.getElementById('bundles-container');
            if (!bundles || bundles.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><div>No bundles found</div></div>';
                return;
            }
            container.innerHTML = '<div class="bundles-grid">' +
                bundles.map(b =>
                    '<div class="bundle-card">' +
                    '<div class="bundle-name">üì¶ ' + b.name + '</div>' +
                    '<div class="bundle-desc">' + b.description + '</div>' +
                    '<div class="bundle-files">' + b.fileCount + ' files</div>' +
                    '</div>'
                ).join('') +
                '</div>';
        }

        // Tools Tab Analytics
        function updateToolsTab() {
            if (!currentData.recentCalls || currentData.recentCalls.length === 0) return;

            const toolStats = {};
            currentData.recentCalls.forEach(call => {
                if (!toolStats[call.tool_name]) {
                    toolStats[call.tool_name] = {
                        name: call.tool_name,
                        count: 0,
                        totalDuration: 0,
                        errors: 0,
                        successes: 0
                    };
                }
                const stats = toolStats[call.tool_name];
                stats.count++;
                if (call.duration_ms) stats.totalDuration += call.duration_ms;
                if (call.status === 'error') stats.errors++;
                if (call.status === 'success') stats.successes++;
            });

            const toolsArray = Object.values(toolStats);
            const container = document.getElementById('tools-grid');

            if (toolsArray.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîß</div><div>No tool data available</div></div>';
                return;
            }

            container.innerHTML = toolsArray.map(tool => {
                const avgDuration = tool.totalDuration > 0 ? (tool.totalDuration / tool.count).toFixed(2) : 0;
                const successRate = ((tool.successes / tool.count) * 100).toFixed(0);
                return `
                    <div class="tool-card">
                        <div class="tool-header">
                            <strong class="tool-name">${tool.name}</strong>
                            <span class="tool-badge">${tool.count}</span>
                        </div>
                        <div class="tool-usage">
                            Success Rate: <strong>${successRate}%</strong><br>
                            Avg Duration: <strong>${avgDuration}ms</strong><br>
                            Errors: <span style="color: var(--error)">${tool.errors}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Violations Tab
        function updateViolationsTab() {
            if (!currentData.recentCalls) return;

            const violations = currentData.recentCalls.filter(c => c.status === 'policy_violation');
            const container = document.getElementById('violations-detailed');

            if (violations.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úì</div><div>No policy violations found</div></div>';
                return;
            }

            container.innerHTML = '<div class="violations-panel">' + violations.map(v =>
                `<div class="violation-item">
                    <strong class="tool-name">${v.tool_name}</strong>: ${v.policy || 'Unknown policy'}
                    <span class="time-ago"> - ${formatTimeAgo(v.timestamp)}</span>
                </div>`
            ).join('') + '</div>';
        }

        // Search and Filter
        document.getElementById('searchInput')?.addEventListener('input', (e) => {
            filterCalls(e.target.value, document.getElementById('statusFilter').value);
        });

        document.getElementById('statusFilter')?.addEventListener('change', (e) => {
            filterCalls(document.getElementById('searchInput').value, e.target.value);
        });

        function filterCalls(searchTerm, status) {
            if (!currentData.recentCalls) return;

            let filtered = currentData.recentCalls;

            if (searchTerm) {
                filtered = filtered.filter(call =>
                    call.tool_name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            if (status !== 'all') {
                filtered = filtered.filter(call => call.status === status);
            }

            renderCalls(filtered);
        }

        function renderCalls(calls) {
            const container = document.getElementById('calls-container');
            if (calls.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div>No matching calls found</div></div>';
                return;
            }

            container.innerHTML = '<table class="log-table">' +
                '<thead><tr><th>Tool</th><th>Status</th><th>Duration</th><th>Time</th></tr></thead>' +
                '<tbody>' +
                calls.map((call, idx) =>
                    `<tr class="clickable-row" onclick="showCallDetails(${idx})">` +
                    '<td class="tool-name">' + call.tool_name + '</td>' +
                    '<td><span class="status-badge status-' + call.status + '">' + call.status + '</span></td>' +
                    '<td>' + (call.duration_ms ? call.duration_ms + 'ms' : '-') + '</td>' +
                    '<td class="time-ago">' + formatTimeAgo(call.timestamp) + '</td>' +
                    '</tr>'
                ).join('') +
                '</tbody></table>';
        }

        // Modal functions
        function showCallDetails(index) {
            const calls = getFilteredCalls();
            const call = calls[index];
            if (!call) return;

            document.getElementById('modalTitle').textContent = `${call.tool_name} - Details`;
            document.getElementById('modalBody').innerHTML = `
                <div class="detail-group">
                    <div class="detail-label">Tool Name</div>
                    <div class="detail-value">${call.tool_name}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">
                        <span class="status-badge status-${call.status}">${call.status}</span>
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Timestamp</div>
                    <div class="detail-value">${new Date(call.timestamp).toLocaleString()}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Duration</div>
                    <div class="detail-value">${call.duration_ms ? call.duration_ms + ' ms' : 'N/A'}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Arguments Hash</div>
                    <div class="detail-value code">${call.args_hash}</div>
                </div>
                ${call.module ? `
                <div class="detail-group">
                    <div class="detail-label">Module</div>
                    <div class="detail-value code">${call.module}</div>
                </div>
                ` : ''}
                ${call.policy ? `
                <div class="detail-group">
                    <div class="detail-label">Policy Violated</div>
                    <div class="detail-value code">${call.policy}</div>
                </div>
                ` : ''}
                ${call.error ? `
                <div class="detail-group">
                    <div class="detail-label">Error Message</div>
                    <div class="detail-value code">${call.error}</div>
                </div>
                ` : ''}
            `;

            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // Close modal on overlay click
        document.getElementById('modal').addEventListener('click', closeModal);

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        function getFilteredCalls() {
            const searchTerm = document.getElementById('searchInput')?.value || '';
            const status = document.getElementById('statusFilter')?.value || 'all';

            let filtered = currentData.recentCalls || [];

            if (searchTerm) {
                filtered = filtered.filter(call =>
                    call.tool_name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            if (status !== 'all') {
                filtered = filtered.filter(call => call.status === status);
            }

            return filtered;
        }

        // Settings
        function toggleSetting(element, setting) {
            element.classList.toggle('on');
            settings[setting] = element.classList.contains('on');
            console.log('Setting changed:', setting, settings[setting]);
        }

        function updateMaxEvents(value) {
            settings.maxEvents = parseInt(value);
            console.log('Max events set to:', value);
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all cached data?')) {
                currentData = { recentCalls: [], total: 0 };
                updateDashboard({ total: 0, success: 0, errors: 0, policyViolations: 0, avgDurationMs: 0, recentCalls: [] });
            }
        }

        // Export functionality
        function exportData() {
            const dataStr = JSON.stringify(currentData.recentCalls, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `mcp-telemetry-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        window.addEventListener('message', event => {
            const message = event.data;
            if (message.command === 'update') {
                updateDashboard(message.data);
                updateConnectionStatus(true);
            } else if (message.command === 'updateBundles') {
                updateBundles(message.bundles);
            } else if (message.command === 'updatePolicies') {
                window.lastPolicies = message.policies;
                updatePoliciesList(message.policies);
            } else if (message.command === 'connectionStatus') {
                updateConnectionStatus(message.connected, message.error);
            }
        });

        function updatePoliciesList(policies) {
            const container = document.getElementById('policies-container');
            const searchTerm = document.getElementById('policySearch')?.value.toLowerCase() || '';

            if (!policies || policies.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìú</div><div>No policies found</div></div>';
                return;
            }

            const filtered = policies.filter(p =>
                p.name.toLowerCase().includes(searchTerm) ||
                p.category.toLowerCase().includes(searchTerm)
            );

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìú</div><div>No matching policies</div></div>';
                return;
            }

            // Group by category
            const grouped = {};
            filtered.forEach(p => {
                if (!grouped[p.category]) grouped[p.category] = [];
                grouped[p.category].push(p);
            });

            let html = '<div class="policies-grid" style="display:grid;gap:16px;">';

            for (const [category, items] of Object.entries(grouped)) {
                html += `
                    <div class="policy-group">
                        <h3 style="margin-bottom:8px;font-size:0.9em;color:var(--text-muted);border-bottom:1px solid var(--border);padding-bottom:4px;">${category}</h3>
                        <div style="display:grid;gap:8px;">
                            ${items.map(p => `
                                <div class="stat-card" style="text-align:left;padding:12px;">
                                    <div style="font-weight:600;margin-bottom:4px;">${p.name}</div>
                                    <div style="font-size:0.8em;color:var(--text-muted);word-break:break-all;">${p.path}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        // Add search listener for policies
        document.getElementById('policySearch')?.addEventListener('input', () => {
            if (window.lastPolicies) updatePoliciesList(window.lastPolicies);
        });

        // Signal that the webview is ready to receive data
        vscode.postMessage({ command: 'webviewReady' });
    </script>
</body>

</html>
