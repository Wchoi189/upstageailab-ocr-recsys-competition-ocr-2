{
    "project": "Airflow Batch Processor via Windows Bridge",
    "version": "1.0.0",
    "description": "Operational schema for Hybrid Airflow 3 Environment (Windows Host + WSL Agent)",
    "architecture": {
        "host_os": "Windows",
        "agent_os": "WSL/Linux",
        "bridge_mechanism": "RabbitMQ",
        "network_topology": "Agent -> RabbitMQ -> Host Python Listener -> Docker Desktop",
        "components": {
            "airflow_stack": [
                "airflow-webserver",
                "airflow-scheduler",
                "postgres"
            ],
            "bridge_server": "windows_agent_bridge/bridge_server.py (Runs on Windows)",
            "bridge_client": "windows_agent_bridge/bridge_client.py (Runs on Agent)"
        }
    },
    "bridge_protocol": {
        "usage_template": "uv run --no-project --with pika python airflow-batch-processor/windows_agent_bridge/bridge_client.py \"{command}\"",
        "allowed_commands": [
            "docker ps",
            "docker logs",
            "docker exec",
            "docker compose"
        ],
        "constraints": [
            "Commands must be explicitly whitelisted in bridge_server.py ALLOWED_COMMANDS list",
            "Prefix matching is strict",
            "Bridge Server must be restarted to reload allowed commands"
        ]
    },
    "critical_configuration": {
        "airflow_3_execution_api": {
            "variable": "AIRFLOW__CORE__EXECUTION_API_SERVER_URL",
            "required_value_pattern": "http://{host}:{port}/execution/",
            "critical_note": "MUST include the /execution/ suffix. Root URL causes 405 Method Not Allowed.",
            "failure_symptom": "httpx.Client errors or ServerResponseError: Method Not Allowed"
        },
        "authentication": {
            "variable": "AIRFLOW__API_AUTH__JWT_SECRET",
            "requirement": "Shared Static String",
            "reason": "Scheduler (Signer) and Webserver (Verifier) must share the same secret key.",
            "failure_symptom": "403 Forbidden / InvalidSignatureError"
        },
        "permissions": {
            "volume_mounts": [
                "data",
                "logs"
            ],
            "action": "chmod 777",
            "reason": "Container user (50000) requires write access to host-mounted volumes."
        }
    },
    "operational_procedures": {
        "stack_restart": [
            {
                "step": 1,
                "description": "Restart Bridge Server (Windows)",
                "condition": "If bridge_server.py source code changed",
                "action": "Manual User Action: Ctrl+C -> python bridge_server.py"
            },
            {
                "step": 2,
                "description": "Recreate Containers",
                "condition": "If docker-compose.yml logic changed (Config/Env)",
                "command": "docker compose up -d --force-recreate",
                "bridge_command": "uv run ... bridge_client.py \"docker compose -f ../docker/docker-compose.yml up -d --force-recreate\""
            }
        ],
        "verification": [
            {
                "step": 1,
                "description": "Trigger DAG",
                "command": "curl -X POST .../dagRuns",
                "success_criteria": "HTTP 200 OK"
            },
            {
                "step": 2,
                "description": "Check Task Status",
                "command": "uv run python airflow-batch-processor/scripts/check_dag_status.py",
                "success_criteria": "Task 'preprocess' state == 'success'"
            }
        ]
    },
    "reproducibility": {
        "docker_desktop": "Ensure Docker Desktop is running on Windows Host.",
        "rabbitmq": "Ensure CloudAMQP or local RabbitMQ is accessible via RABBITMQ_URL env var.",
        "uv_cache": "Agent uses `uv` for python dependency management; ensure internet access for first run."
    }
}