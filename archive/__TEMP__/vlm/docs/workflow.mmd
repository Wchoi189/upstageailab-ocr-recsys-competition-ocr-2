graph TD
    A[User selects images] --> B{Manual annotations?}
    B -->|Yes| C[Annotate in VIA]
    B -->|No| D[Load images]
    C --> E[Export VIA annotations]
    E --> D
    D --> F[Preprocess images]
    F --> G{Backend selection}
    G -->|Available| H[OpenRouter API]
    G -->|Fallback| I[Solar Pro 2 API]
    G -->|Fallback| J[CLI Qwen VLM]
    H --> K[Generate prompt]
    I --> K
    J --> K
    K --> L{Load few-shot examples?}
    L -->|Yes| M[Inject examples]
    L -->|No| N[Render template]
    M --> N
    N --> O[Send to VLM]
    O --> P[Receive analysis]
    P --> Q{Format output}
    Q -->|JSON| R[JSON output]
    Q -->|Markdown| S[Markdown output]
    Q -->|Text| T[Plain text]
    R --> U{Auto-populate?}
    S --> U
    T --> U
    U -->|Yes| V[Update report]
    U -->|No| W[Display result]
    V --> W

    style A fill:#e1f5ff
    style P fill:#fff4e1
    style W fill:#e8f5e9
