---
# Backend Service Layer Contracts
# Location: apps/ocr-inference-console/backend/services/

CheckpointService:
  module: "backend.services.checkpoint_service"
  responsibility: "Checkpoint discovery + TTL caching"
  location: "apps/ocr-inference-console/backend/services/checkpoint_service.py"

  interface:
    list_checkpoints:
      signature: "async (limit: int = 100) -> list[Checkpoint]"
      behavior: "Return cached if TTL valid, else rediscover"

    get_latest:
      signature: "() -> Checkpoint | None"
      behavior: "Return first cached checkpoint or None"

    preload_checkpoints:
      signature: "async (limit: int = 100) -> None"
      behavior: "Background cache warm-up on startup"

  state:
    _cache: "list[Checkpoint] | None"
    _last_update: "datetime | None"
    cache_ttl: "float (default: 5.0s)"

  init:
    signature: "(checkpoint_root: Path, cache_ttl: float = 5.0)"

InferenceService:
  module: "backend.services.inference_service"
  responsibility: "InferenceEngine lifecycle + prediction"
  location: "apps/ocr-inference-console/backend/services/inference_service.py"

  interface:
    predict:
      signature: "async (image: np.ndarray, checkpoint_path: str, confidence_threshold: float, nms_threshold: float, enable_perspective_correction: bool = False, perspective_display_mode: str = 'overlay', enable_grayscale: bool = False, enable_background_normalization: bool = False, enable_sepia_enhancement: bool = False) -> dict"
      behavior: "Lazy-load engine on first use, reuse checkpoint if unchanged"

    cleanup:
      signature: "() -> None"
      behavior: "Release engine resources"

  state:
    _engine: "InferenceEngine | None"
    _current_checkpoint: "str | None"

PreprocessingService:
  module: "backend.services.preprocessing_service"
  responsibility: "Image decoding + validation"
  location: "apps/ocr-inference-console/backend/services/preprocessing_service.py"

  interface:
    decode_base64_image:
      signature: "static (image_base64: str) -> np.ndarray"
      behavior: "Strip data URL prefix, decode base64, return BGR numpy array"
      raises: "ValueError on decode failure"

# Service Initialization Pattern (main.py lifespan)
initialization:
  - "CheckpointService(checkpoint_root=DEFAULT_CHECKPOINT_ROOT, cache_ttl=5.0)"
  - "InferenceService() # lazy-loads engine on first predict()"
  - "asyncio.create_task(_checkpoint_service.preload_checkpoints())"

cleanup:
  - "_inference_service.cleanup() # release engine resources"
